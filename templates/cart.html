{% extends 'base.html' %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <script src="https://code.jquery.com/jquery-3.7.0.js"
        integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>

    <title>Document</title>
</head>

<body>
    {% if product %}
    <h1 style="margin-top: 100px;"><a href="{% url 'order_status' %}"> See orders details</a></h1>

    <div class="container">
        <div class="row">
            {% for i in product %}
            <form action="{% url 'update_cart' i.pid %}" method="post" class="update-cart-form" data-product-id="{{ i.pid }}">
                {%  csrf_token %}
                <div class="row">
         {% for j in fix_price %}
                {% if i.pid == j.pid %}
                <input type="hidden" name="fixprice" id="fixprice" class="fixprice" value="{{j.pprice}}">
                {% endif %}

                {% endfor %}
                </div>
       
               
                <div class="col-xxl-4 col-xl-4 col-lg-4 col-md-4 col-sm-4 mt-5" style="height: 100px;">
                    <img src="{% static 'images/' %}{{ i.pimage }}" alt="..." class="img-fluid h-100">
                </div>
                <div class="col-xxl-4 col-xl-4 col-lg-4 col-md-4 col-sm-4 mt-5 pprice">$ {{ i.pprice }}</div>
                <div class="col-xxl-4 col-xl-4 col-lg-4 col-md-4 col-sm-4">
                    <input type="number" name="quantity" class="quantity" value="{{ i.pnumber }}" min="1" max="5">
                </div>
                <a href="{% url 'delete_cart' i.pid %}" onclick="return"  ><button class="btn btn-primary" type="button">Delete item</button></a>
                <a href="{% url 'confirm_order' i.pid %}">confirm order</a>
                <!-- <button id="rzp-button1" type="button" class="btn btn-primary rzp-button1" data-price="{{ i.pprice }}" data>Pay with Razorpay</button> -->
                <button type="button" class="btn btn-primary razorpay-button" data-product-id="{{ i.pid }}" data-price="{{ i.pprice }}">Pay with Razorpay</button>

            </form>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <h1 style="margin-top: 100px;">NO item in cart</h1>
    {% endif %}
</body>
<script>
    $(document).ready(function () {
        $(".update-cart-form .quantity").on("input", function () {
            var input = $(this);
            var form = input.closest("form");
            // var productId = form.data("product-id");
            var quantity = input.val();
            var priceElement = form.find(".pprice");
            var fixp = form.find(".fixprice").val()
            console.log(fixp)
            // var price = priceElement.text(); // Get the initial price value
            // var price = parseFloat(form.data(" data-initial-price")); // Get the initial price value

            var updatedPrice = calculateUpdatedPrice(fixp, quantity);
            priceElement.text("$" + updatedPrice); // Update the price inside the div element

            var formData = {
                pquantitiy: quantity,
                pprice: updatedPrice, // Include the updated price in the form data

                csrfmiddlewaretoken: '{{ csrf_token }}'
            };

            $.ajax({
                type: "POST",
                url: form.attr("action"),
                data: formData,
                dataType: "json",
                success: function (response) {
                    console.log(response['response']);
                },
                error: function (response) {
                    alert("error");
                }
            });
        });
    });
    function calculateUpdatedPrice(fixp, quantity) {
        // Add your calculation logic here
        // For example, multiplying the price by the quantity
        var updatedPrice = parseFloat(fixp) * parseInt(quantity);
        console.log("calculateUpdatedPrice", updatedPrice)
        document.getElementsByClassName(".fixprice").innerHTML = updatedPrice;
        return updatedPrice.toFixed(2); // Return the updated price with 2 decimal places
    }


</script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    // Function to handle Razorpay payment for a specific product
    function handleRazorpayPayment(productID, price) {
        console.log("okkkkkkkkkkkkkkk",productID)
        var options = {
            "key": "rzp_test_816c98EFuVJQYi", // Replace with your Razorpay Key ID
            "amount": price,  // Amount is in currency subunits (paise in this case)
            "currency": "INR",
            "name": "Acme Corp",
            "description": "Test Transaction",
            "order_id": "",  // We will fill this with the server-generated order ID
            "handler": function (response) {
                // Handle the payment success (you can perform any action here)
                console.log(response);
                alert("Payment Successful!");
            },
            "prefill": {
                "name": "Gaurav Kumar",
                "email": "gaurav.kumar@example.com",
                "contact": "9000090000"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#3399cc"
            }
        };

        // Make an API call to generate the Razorpay order and get the order_id

        $.ajax({
            
            type: "POST",
            url:"{% url 'generate_razorpay_order' 1 %}",
            data: { "product_id": productID, "csrfmiddlewaretoken": '{{ csrf_token }}' },
            dataType: "json",
            success: function (response) {
                options.order_id = response.order_id;
                var rzp = new Razorpay(options);
                rzp.open();
            },
            error: function (response) {
                alert("Error generating Razorpay order. Please try again later.");
            }
        });
    }

    // Attach click event to the Razorpay payment buttons
    $(document).on("click", ".razorpay-button", function (event) {
        event.preventDefault();
        var productID = $(this).data("product-id");
        var price = $(this).data("price");
        console.log(productID,price)
        handleRazorpayPayment(productID, price);
    });
    console.log("okkkk")
</script>


<script src="{% static 'js/bootstrap.min.js' %}"></script>

</html>
{% endblock %}